name: Telegram Bot

on:
  schedule:
    - cron: '*/15 * * * *'  # Run every 15 minutes
  workflow_dispatch:  # Allow manual trigger

jobs:
  run-bot:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install playwright
        playwright install chromium

    - name: Restore Auth Session
      env:
        TWITTER_AUTH: ${{ secrets.TWITTER_AUTH }}
      run: |
        if [ -z "$TWITTER_AUTH" ]; then
          echo "⚠️ TWITTER_AUTH secret is not set. Bot will run without authentication."
          echo "   This may result in limited functionality or outdated tweet data."
        else
          echo "$TWITTER_AUTH" | base64 -d > auth.json
          if [ ! -s auth.json ]; then
            echo "⚠️ Failed to decode TWITTER_AUTH secret. Removing empty auth.json."
            rm -f auth.json
          else
            echo "✅ Successfully restored authentication session."
          fi
        fi

    - name: Run Bot
      env:
        BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
        CHANNEL_ID: ${{ secrets.CHANNEL_ID }}
        TWITTER_USER: ${{ secrets.TWITTER_USER }}
      run: python main.py --once

    - name: Commit State (Seen Tweets)
      run: |
        git config --global user.name 'GitHub Action Bot'
        git config --global user.email 'action@github.com'
        git add -f seen_tweets.json
        git diff --quiet && git diff --staged --quiet || (git commit -m "Update seen tweets [skip ci]" && git push)
